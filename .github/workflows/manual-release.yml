name: Manual Release

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      description:
        description: 'Release description (optional)'
        required: false
        type: string

jobs:
  create-changeset:
    name: Create Changeset and Commit to Main
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm install

      - name: Create changeset file
        run: |
          # Generate a random changeset ID
          CHANGESET_ID=$(openssl rand -hex 4)
          CHANGESET_FILE=".changeset/manual-release-${CHANGESET_ID}.md"

          # Get bump type from workflow input
          BUMP_TYPE="${{ github.event.inputs.bump_type }}"

          # Get description from workflow input or use default
          if [ -n "${{ github.event.inputs.description }}" ]; then
            DESCRIPTION="${{ github.event.inputs.description }}"
          else
            DESCRIPTION="Manual ${BUMP_TYPE} release"
          fi

          # Create the changeset file with single quotes to match Prettier config
          cat > "$CHANGESET_FILE" <<EOF
          ---
          'lino-env': ${BUMP_TYPE}
          ---

          ${DESCRIPTION}
          EOF

          echo "Created changeset: $CHANGESET_FILE"
          cat "$CHANGESET_FILE"

      - name: Format changeset with Prettier
        run: |
          # Run Prettier on the changeset file to ensure it matches project style
          npx prettier --write ".changeset/*.md" || true

          echo "Formatted changeset files"

      - name: Commit and push to main
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add changeset file
          git add .changeset/

          # Commit with descriptive message
          git commit -m "chore: add changeset for manual ${{ github.event.inputs.bump_type }} release" \
                     -m "" \
                     -m "Release type: ${{ github.event.inputs.bump_type }}" \
                     -m "Description: ${{ github.event.inputs.description || 'Manual release' }}" \
                     -m "Triggered by: @${{ github.actor }}" \
                     -m "" \
                     -m "ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)"

          # Push directly to main
          git push origin main

          echo "âœ… Changeset committed and pushed to main"
          echo "The automated release workflow will now process this changeset."
